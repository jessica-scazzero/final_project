---
title: "testing/data manipulation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
```


```{r setup, include=FALSE}

cash <- read_csv("who_uses_cash/merged.csv")

time_payment <- cash %>%
mutate(time_rounded = 100*ceiling((time)/100)) %>%
  filter(!time_rounded %in% c("2450", NA, "0")) %>%
  mutate(payment = ifelse(pi == 3, 1, 0)) %>%
  filter(!is.na(payment)) %>% 
  group_by(time_rounded, payment) %>%
  count() %>% 
  ungroup() %>% 
  group_by(time_rounded) %>% 
  mutate(n = ifelse(payment == 0, sum(n), n))

ggplot(time_payment, aes(x=time_rounded, y=n, color = payment)) + geom_point()

time_transaction_type <- cash %>%
mutate(time_rounded = 100*ceiling((time)/100)) %>%
  filter(!time_rounded %in% c("2450", NA, "0")) %>%
  mutate(merch_type = ifelse(merch == 4, 1, 0)) %>%
  filter(!is.na(merch_type)) %>% 
  group_by(time_rounded, merch_type) %>%
  count() %>% 
  ungroup() %>% 
  group_by(time_rounded) %>% 
  mutate(n = ifelse(merch_type == 0, sum(n), n))

ggplot(time_transaction_type, aes(x=time_rounded, y=n, color = merch_type)) + geom_point()


time_transaction_type_2 <- cash %>%
mutate(time_rounded = 100*ceiling((time)/100)) %>%
  filter(!time_rounded %in% c("2450", NA, "0")) %>%
  mutate(time_rounded = as.numeric(time_rounded)) %>%
  filter(!is.na(merch)) %>% 
  group_by(time_rounded) %>%
  summarise(avg = sum(merch == 3)/n(), na.rm = TRUE)

ggplot(time_transaction_type_2, aes(x=time_rounded, y=avg)) + geom_line() + labs(title = "Change in Transaction Ty", x = "Time", y = "Frequency of Transaction Type") + scale_x_continuous(breaks = c(400, 800, 1200, 1600, 2000, 2400), labels=c("4am", "8am", "12pm", "4pm", "8pm", "12am"))

income <- cash %>%
  filter(income_hh == 8) %>%
  filter(pi %in% c(1,2,3,4,5,6,7)) %>%
  group_by(pi) %>%
  count() %>%
  mutate(avg = sum(pi == 1)/sum(n))

merged_2 <- cash %>%
mutate(education_level = ifelse(highest_education %in% c(1,2,3,4,5,6,7,8), 1,
                   ifelse(highest_education == 9, 2,
                   ifelse(highest_education %in% c(11,12), 3,
                   ifelse(highest_education == 13, 4,
                   ifelse(highest_education == 14, 5,
                   ifelse(highest_education == 15, 6, 
                   ifelse(highest_education == 16, 7, 0)))))))) %>%
mutate(income_level = ifelse(income_hh %in% c(1,2,3,4), 1,
                  ifelse(income_hh %in% c(4,5,6), 2,
                  ifelse(income_hh %in% c(7,8), 3,
                  ifelse(income_hh %in% c(9,10), 4,
                  ifelse(income_hh == 11, 5,
                  ifelse(income_hh == 12, 6,
                  ifelse(income_hh == 13, 7,
                  ifelse(income_hh == 14, 8,
                  ifelse(income_hh == 15, 9,
                  ifelse(income_hh == 16, 10,
                  ifelse(income_hh == 17, 11,
                  ifelse(income_hh == 18, 12, 0)))))))))))))
  
write.csv(merged_2, file = "merged_2.csv")

summary(merged_2$age)

graph <- cash %>%
    filter(income_hh == 12) %>%
      filter(pi %in% c(1,2,3,4,5,6,7)) %>%
      group_by(pi) %>%
      count()

ggplot(graph, aes(x=factor(pi), y=n, fill=factor(ifelse(pi=="1","Highlighted","Normal")))) + geom_col(show.legend = FALSE) + scale_fill_manual(name = "pi", values = c("#18BC9C", "#2C3E50")) + labs(title = "Frequency of Payment Methods Used", x= "Payment Method", y = "Count") + scale_x_discrete(labels=c("1" = "Cash", "2" = "Check", "3" = "Credit Card", "4" = "Debit Card", "5" = "Prepaid/Gift", "6" = "Bank Account", "7" = "Online Payment")) + theme(axis.text.x=element_text(angle=45, hjust=1))

graph2 <- cash %>%
  mutate(pi_2 = ifelse(pi == 1, 1,
                ifelse(pi == 2, 2,
                ifelse(pi == 3, 3,
                ifelse(pi == 4, 4, 5))))) %>%
filter(pi_2 %in% c(1,3,4)) %>%
filter(merch %in% c(1,2,3,4,5,6,7)) %>%
mutate(merch = fct_relevel(as.factor(merch), c("3", "5", "6", "2", "4", "1", "7"))) %>%
drop_na(merch) %>%
filter(year == "2015")

check <- cash %>%
select(merch)

ggplot(graph2, aes(merch, fill = pi_2)) + geom_bar()

graph3 <- graph2 %>%
  group_by(merch) %>%
  count()

p <-ggplot(graph2, aes(x = merch, y = stat(count), fill = pi))

p

ggplot(data = graph2) + 
geom_bar(mapping = aes(x = as.factor(merch), fill = as.factor(pi_2))) +  scale_fill_manual(values = c("#18BC9C", "#2C3E50", "#3498DB"), name = "Payment Type", labels=c("Cash", "Debit Card", "Credit Card")) + scale_x_discrete(labels=c( "7" = "Arts & Entertainment", "1" = "Convenience & Grocery", "4" = "Fast-food & Cafes", "2" = "Gas stations", "6" = "General Services", "3" = "Sit-down Restaurants",  "5" = "Shopping")) + theme(axis.text.x=element_text(angle=45, hjust=1)) + coord_flip() + labs(title = "Frequency of Transaction Type by Payment", x = "Transaction Type", y = "Frequency", fill = "Payment Type")

#F39C12 #E74C3C

ggplot(graph2, aes(x = merch, y = pi_2, fill = pi_2)) + geom_bar() +

```